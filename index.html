  function circularStandardDeviation(phases) {
    const R = meanResultantLength(phases);
    return Math.sqrt(-2 * Math.log(R));
  }

  function circularSkewness(phases) {
    if (phases.length === 0) return 0;
    let sumSin = 0, sumCos = 0;
    phases.forEach(p => {
      sumSin += Math.sin(p);
      sumCos += Math.cos(p);
    });
    const thetaBar = Math.atan2(sumSin, sumCos);

    let num = 0;
    phases.forEach(p => {
      const angle = ((p - thetaBar + 2 * Math.PI) % (2 * Math.PI));
      num += Math.sin(2 * angle);
    });

    return num / phases.length;
  }

  function rayleighTestStatistic(phases) {
    const R = meanResultantLength(phases);
    return 2 * phases.length * R * R;
  }

  function exportCSV() {
    const header = ["Throb #", "Time (ms)", "Phase (radians)"];
    const rows = throbs.map((t, i) => [
      i + 1,
      (t.time - recordingStartTime).toFixed(1),
      t.phase !== null ? t.phase.toFixed(4) : "N/A"
    ]);

    const phases = throbs.map(t => t.phase).filter(p => p !== null);
    const plv = calculatePLV();
    const meanPh = meanPhase(phases);
    const varPh = phaseVariance(phases);
    const stdDev = circularStandardDeviation(phases);
    const skew = circularSkewness(phases);
    const rayleigh = rayleighTestStatistic(phases);
    const duration = pulseWave.length > 0
      ? (pulseWave[pulseWave.length - 1].time - recordingStartTime).toFixed(1)
      : "N/A";

    let csv = header.join(",") + "\n";
    rows.forEach(row => csv += row.join(",") + "\n");

    csv += `\nPLV:,${plv.toFixed(4)}\n`;
    csv += `Mean Phase Angle (radians):,${meanPh !== null ? meanPh.toFixed(4) : "N/A"}\n`;
    csv += `Phase Variance:,${varPh.toFixed(4)}\n`;
    csv += `Circular Std Dev:,${stdDev.toFixed(4)}\n`;
    csv += `Circular Skewness:,${skew.toFixed(4)}\n`;
    csv += `Rayleigh Test Statistic:,${rayleigh.toFixed(4)}\n`;
    csv += `Number of Throbs:,${phases.length}\n`;
    csv += `Recording Duration (ms):,${duration}\n`;

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const name = `simulated_throb_${Date.now()}.csv`;
    a.href = url;
    a.download = name;
    a.click();
    URL.revokeObjectURL(url);

    const li = document.createElement("li");
    li.textContent = name;
    recordingsList.appendChild(li);
  }
