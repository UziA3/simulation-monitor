<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pulse-Throb Simulator</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 0; padding: 0; background: #f7f7f7; }
    canvas { background: #fff; border: 1px solid #ccc; display: block; margin: 20px auto; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    #recordings { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Pulse-Throb Simulator</h1>
  <canvas id="waveform" width="800" height="200"></canvas>
  <div>
    <button onclick="startRecording()">Start Recording</button>
    <button onclick="pauseRecording()">Pause</button>
    <button onclick="resumeRecording()">Resume</button>
    <button onclick="stopRecording()">Stop Recording</button>
    <button onclick="markThrob()">Throb</button>
    <button onclick="downloadCSV()">Download CSV</button>
  </div>
  <div id="recordings"></div>

  <script>
    const canvas = document.getElementById('waveform');
    const ctx = canvas.getContext('2d');
    let pulseData = [];
    let throbTimestamps = [];
    let markers = [];
    let isRecording = false;
    let startTime = 0;
    let animationFrame;

    function generatePulse(t) {
      return 50 * Math.sin(2 * Math.PI * 1.2 * t) + 100;
    }

    function drawWaveform(timeOffset) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      for (let x = 0; x < canvas.width; x++) {
        let t = (x + timeOffset) / 100;
        let y = generatePulse(t);
        ctx.lineTo(x, canvas.height / 2 - y / 2);
      }
      ctx.strokeStyle = 'blue';
      ctx.stroke();

      // Draw markers
      markers.forEach(marker => {
        let x = canvas.width - ((Date.now() - marker.timestamp) / 10);
        if (x >= 0 && x <= canvas.width) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, canvas.height);
          ctx.strokeStyle = 'red';
          ctx.stroke();
        }
      });
    }

    function animate() {
      let now = Date.now();
      drawWaveform(now - startTime);
      animationFrame = requestAnimationFrame(animate);
    }

    function startRecording() {
      pulseData = [];
      throbTimestamps = [];
      markers = [];
      startTime = Date.now();
      isRecording = true;
      animate();
    }

    function pauseRecording() {
      cancelAnimationFrame(animationFrame);
      isRecording = false;
    }

    function resumeRecording() {
      if (!isRecording) {
        isRecording = true;
        animate();
      }
    }

    function stopRecording() {
      cancelAnimationFrame(animationFrame);
      isRecording = false;
    }

    function markThrob() {
      if (isRecording) {
        const timestamp = Date.now() - startTime;
        throbTimestamps.push(timestamp);
        markers.push({ timestamp: Date.now() });
      }
    }

    function downloadCSV() {
      let csv = 'ThrobTimestamp(ms)\n';
      throbTimestamps.forEach((t) => {
        csv += `${t}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `throb_recording_${Date.now()}.csv`;
      a.click();
    }
  </script>
</body>
</html>
</body>
</html>
