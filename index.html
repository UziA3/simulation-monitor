<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pulse Throb Monitor with PLV and Peak Analysis</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    canvas { border: 1px solid #ccc; margin-bottom: 10px; }
    button { margin: 5px; }
    #statsBox { margin-top: 10px; display: none; }
  </style>
</head>
<body>
<h1>Pulse Throb Monitor (Simulated)</h1>
<canvas id="canvas" width="800" height="200"></canvas><br>

<button id="startBtn">Start</button>
<button id="pauseBtn" disabled>Pause</button>
<button id="resumeBtn" disabled>Resume</button>
<button id="stopBtn" disabled>Stop</button>
<button id="throbBtn" disabled>Mark Throb</button>
<button id="toggleStatsBtn">Toggle Stats Display</button>

<div>Timer: <span id="timer">00:00</span></div>
<ul id="recordingsList"></ul>

<div id="statsBox">
  <p><strong>PLV:</strong> <span id="plvVal"></span></p>
  <p><strong>Mean Phase Angle:</strong> <span id="meanAngle"></span></p>
  <p><strong>Phase Variance:</strong> <span id="phaseVariance"></span></p>
  <p><strong>Total Peaks:</strong> <span id="totalPeaks"></span></p>
  <p><strong>Mean Pulse Rate:</strong> <span id="meanPulseRate"></span> bpm</p>
</div>

<script>
(() => {
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const startBtn = document.getElementById("startBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const resumeBtn = document.getElementById("resumeBtn");
  const stopBtn = document.getElementById("stopBtn");
  const throbBtn = document.getElementById("throbBtn");
  const toggleStatsBtn = document.getElementById("toggleStatsBtn");
  const timerDisplay = document.getElementById("timer");
  const recordingsList = document.getElementById("recordingsList");
  const statsBox = document.getElementById("statsBox");
  const plvVal = document.getElementById("plvVal");
  const meanAngle = document.getElementById("meanAngle");
  const phaseVariance = document.getElementById("phaseVariance");
  const totalPeaksSpan = document.getElementById("totalPeaks");
  const meanPulseRateSpan = document.getElementById("meanPulseRate");

  let pulseWave = [];
  let fullPulseWave = [];
  let throbs = [];
  let peaks = [];
  let recordingStartTime = null;
  let isRecording = false;
  let isPaused = false;
  let timerInterval = null;
  let animationId;
  let lastSampleTime = 0;

  const DISPLAY_DURATION = 20000; // 20s
  const SAMPLE_INTERVAL = 20;     // ms
  const WAVE_BASELINE = 100;
  const WAVE_AMPLITUDE = 50;
  let WAVE_FREQ = 1.2 + Math.random() * 0.5;

  function simulatePulse() {
    const now = performance.now();
    if (now - lastSampleTime >= SAMPLE_INTERVAL) {
      const t = now / 1000;
      const value = WAVE_BASELINE + WAVE_AMPLITUDE * Math.sin(2 * Math.PI * WAVE_FREQ * t);
      const point = { time: now, value };
      pulseWave.push(point);
      fullPulseWave.push(point);
      lastSampleTime = now;
    }
    const cutoff = performance.now() - DISPLAY_DURATION;
    pulseWave = pulseWave.filter(p => p.time >= cutoff);
  }

  function draw() {
    simulatePulse();
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const now = performance.now();
    const start = now - DISPLAY_DURATION;

    ctx.beginPath();
    pulseWave.forEach((p, i) => {
      const x = ((p.time - start) / DISPLAY_DURATION) * canvas.width;
      const y = canvas.height - p.value;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.strokeStyle = "blue";
    ctx.stroke();

    // Peaks
    peaks.forEach(p => {
      if (p < start || p > now) return;
      const val = interpolatePulseValue(p);
      const x = ((p - start) / DISPLAY_DURATION) * canvas.width;
      const y = canvas.height - val;
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, 2 * Math.PI);
      ctx.fillStyle = "green";
      ctx.fill();
    });

    // Throbs
    throbs.forEach(throb => {
      if (throb.time < start || throb.time > now) return;
      const val = interpolatePulseValue(throb.time);
      const x = ((throb.time - start) / DISPLAY_DURATION) * canvas.width;
      const y = canvas.height - val;
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, 2 * Math.PI);
      ctx.fillStyle = "red";
      ctx.fill();
    });

    if (isRecording && !isPaused) animationId = requestAnimationFrame(draw);
  }

  function interpolatePulseValue(t) {
    for (let i = 1; i < pulseWave.length; i++) {
      if (pulseWave[i].time >= t) {
        const p1 = pulseWave[i - 1];
        const p2 = pulseWave[i];
        const ratio = (t - p1.time) / (p2.time - p1.time);
        return p1.value + ratio * (p2.value - p1.value);
      }
    }
    return null;
  }

  function detectPeaks(data) {
    const peakTimes = [];
    const window = 2;
    for (let i = window; i < data.length - window; i++) {
      const cur = data[i].value;
      let isPeak = true;
      for (let j = 1; j <= window; j++) {
        if (cur <= data[i - j].value || cur <= data[i + j].value) {
          isPeak = false;
          break;
        }
      }
      if (isPeak) peakTimes.push(data[i].time);
    }
    return peakTimes;
  }

  function calculatePhase(t) {
    for (let i = 0; i < peaks.length - 1; i++) {
      if (peaks[i] <= t && peaks[i + 1] > t) {
        return 2 * Math.PI * (t - peaks[i]) / (peaks[i + 1] - peaks[i]);
      }
    }
    return null;
  }

  function calculateStats() {
    const valid = throbs.filter(t => t.phase !== null);
    let sumReal = 0, sumImag = 0;
    valid.forEach(t => {
      sumReal += Math.cos(t.phase);
      sumImag += Math.sin(t.phase);
    });
    const plv = valid.length > 0 ? Math.sqrt(sumReal ** 2 + sumImag ** 2) / valid.length : 0;
    const meanAngleVal = Math.atan2(sumImag, sumReal);
    const phaseVar = 1 - plv;

    const duration = (performance.now() - recordingStartTime) / 60000; // in minutes
    const pulseRate = duration > 0 ? (peaks.length / duration) : 0;

    return {
      plv: plv.toFixed(4),
      meanAngle: meanAngleVal.toFixed(4),
      phaseVariance: phaseVar.toFixed(4),
      totalPeaks: peaks.length,
      meanPulseRate: pulseRate.toFixed(2)
    };
  }

  function exportCSV(stats) {
    const header = ["Throb #", "Time (ms)", "Phase (radians)"];
    const rows = throbs.map((t, i) => [
      i + 1,
      (t.time - recordingStartTime).toFixed(1),
      t.phase !== null ? t.phase.toFixed(4) : "N/A"
    ]);
    let csv = header.join(",") + "\n";
    rows.forEach(row => csv += row.join(",") + "\n");
    csv += `\nPLV:,${stats.plv}\nMean Phase Angle:,${stats.meanAngle}\nPhase Variance:,${stats.phaseVariance}\nTotal Peaks:,${stats.totalPeaks}\nMean Pulse Rate (bpm):,${stats.meanPulseRate}\n`;

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const name = `simulated_throb_${Date.now()}.csv`;
    a.href = url;
    a.download = name;
    a.click();
    URL.revokeObjectURL(url);

    const li = document.createElement("li");
    li.textContent = name;
    recordingsList.appendChild(li);
  }

  function updateTimer() {
    const elapsed = performance.now() - recordingStartTime;
    const mins = Math.floor(elapsed / 60000);
    const secs = Math.floor((elapsed % 60000) / 1000);
    timerDisplay.textContent = `${String(mins).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;
  }

  // Button logic
  toggleStatsBtn.onclick = () => {
    statsBox.style.display = statsBox.style.display === "none" ? "block" : "none";
  };

  startBtn.onclick = () => {
    throbs = [];
    peaks = [];
    fullPulseWave = [];
    WAVE_FREQ = 1.2 + Math.random() * 0.5;
    recordingStartTime = performance.now();
    isRecording = true;
    isPaused = false;
    startBtn.disabled = true;
    pauseBtn.disabled = false;
    stopBtn.disabled = false;
    throbBtn.disabled = false;
    timerInterval = setInterval(updateTimer, 100);
    draw();
  };

  pauseBtn.onclick = () => {
    isPaused = true;
    pauseBtn.disabled = true;
    resumeBtn.disabled = false;
    cancelAnimationFrame(animationId);
    clearInterval(timerInterval);
  };

  resumeBtn.onclick = () => {
    isPaused = false;
    pauseBtn.disabled = false;
    resumeBtn.disabled = true;
    timerInterval = setInterval(updateTimer, 100);
    draw();
  };

  stopBtn.onclick = () => {
    isRecording = false;
    clearInterval(timerInterval);
    cancelAnimationFrame(animationId);
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    resumeBtn.disabled = true;
    stopBtn.disabled = true;
    throbBtn.disabled = true;
    peaks = detectPeaks(fullPulseWave);
    throbs = throbs.map(t => ({ ...t, phase: calculatePhase(t.time) }));
    const stats = calculateStats();
    exportCSV(stats);
    plvVal.textContent = stats.plv;
    meanAngle.textContent = stats.meanAngle;
    phaseVariance.textContent = stats.phaseVariance;
    totalPeaksSpan.textContent = stats.totalPeaks;
    meanPulseRateSpan.textContent = stats.meanPulseRate;
  };

  throbBtn.onclick = () => {
    const t = performance.now();
    const phase = calculatePhase(t);
    throbs.push({ time: t, phase });
  };
})();
</script>
</body>
</html>
